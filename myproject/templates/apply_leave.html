{% extends 'dashboard.html' %}

{% block mynav %}

<div class="p-4 shadow rounded bg-white">
  <div class="text-end mb-3">
    <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#leaveHistoryModal">
      Leave Apply History
    </button>
  </div>

  <form action="{% url 'add_apply_leave' %}" method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Display success/error messages -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    <div class="mb-3">
      <label for="leave_date" class="form-label">Leave Date</label>
      <input id="leave_date" name="leave_date" type="date" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="leave_message" class="form-label">Leave Message</label>
      <textarea class="form-control" name="leave_message" id="leave_message" rows="8" required></textarea>
    </div>

    <div class="d-grid">
      <button type="submit" class="btn btn-success">Apply Leave</button>
    </div>
  </form>
</div>

<!-- ✅ Leave Apply History Modal -->
<div class="modal fade" id="leaveHistoryModal" tabindex="-1" aria-labelledby="leaveHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="leaveHistoryModalLabel">Leave Apply History</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <!-- Search and Show entries section -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="me-2">Show</label>
            <select class="form-select d-inline-block w-auto" id="entriesPerPage">
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span class="ms-2">entries</span>
          </div>
          <div class="col-md-6 text-end">
            <label class="me-2">Search:</label>
            <input type="text" class="form-control d-inline-block w-auto" id="searchInput" placeholder="Search...">
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle">
            <thead class="table-dark">
              <tr>
                <th>Date</th>
                <th>Message</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="leaveHistoryTable">
              {% for i in staff_leave_history %}
              <tr>
                <td>{{ i.date }}</td>
                <td>{{ i.message }}</td>
                <td class="text-center">
                  {% if i.status == 0 %}
                    <button class="btn btn-info btn-sm" disabled>Request are Pending</button>
                  {% elif i.status == 1 %}
                    <button class="btn btn-success btn-sm" disabled>Approved</button>
                  {% else %}
                    <button class="btn btn-danger btn-sm" disabled>Rejected</button>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="3" class="text-center text-muted py-4">No leave history available</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination info -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div>
            <span id="paginationInfo">Showing 1 to {{ staff_leave_history|length }} of {{ staff_leave_history|length }} entries</span>
          </div>
          <div>
            <nav>
              <ul class="pagination mb-0">
                <li class="page-item disabled">
                  <a class="page-link" href="#" tabindex="-1">Previous</a>
                </li>
                <li class="page-item disabled">
                  <a class="page-link" href="#">Next</a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

<!-- ✅ JavaScript for search functionality -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const tableBody = document.getElementById('leaveHistoryTable');

    if (searchInput && tableBody) {
      searchInput.addEventListener('keyup', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = tableBody.getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const text = row.textContent.toLowerCase();

          if (text.includes(searchTerm)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        }
      });
    }
  });
</script>

<!-- ✅ Bootstrap JS (if not already included) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}